name: Deploy to Docker Server

# –ò–º—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ –∏–ª–∏ "Manual run", –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
run-name: "üöÄ Deploy: ${{ github.event.head_commit.message || 'Manual run' }}"

# –¢—Ä–∏–≥–≥–µ—Ä ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å workflow –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches:
      - main

jobs:
  deploy:
    # GitHub Actions –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å—ë –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π Ubuntu
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
        # –≠—Ç–æ—Ç —à–∞–≥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        # (commit, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–≤–∞–ª workflow) –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é GitHub runner

      # 2Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º ssh-agent –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
      - name: Start SSH agent and add private key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}
        # –ó–¥–µ—Å—å GitHub Actions —Å–æ–∑–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π ssh-agent
        # –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –Ω–µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞ DEPLOY_KEY
        # –¢–µ–ø–µ—Ä—å –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ SSH-–∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

      # 3Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–µ–ø–ª–æ—è
      - name: SSH to server and run deploy script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}       # IP-–∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞
          username: ${{ secrets.SERVER_USER }}   # SSH-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          script: |                              # –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –±–ª–æ–∫ —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
            echo "Triggering secure deploy..."
            ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}
        # –≠—Ç–æ—Ç —à–∞–≥ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.
        # –ü–∞—Ä–∞–º–µ—Ç—Ä "-o StrictHostKeyChecking=no" –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É "–¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞",
        # —á—Ç–æ–±—ã GitHub Actions –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.
        # –û–±—ã—á–Ω–æ –∑–¥–µ—Å—å –∑–∞–ø—É—Å–∫–∞—é—Ç –¥–µ–ø–ª–æ–π-—Å–∫—Ä–∏–ø—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Docker, git pull, npm build –∏ —Ç.–¥.)
